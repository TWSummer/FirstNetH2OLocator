<!-- https://friendly-hamilton-e4a999.netlify.com -->
<!-- https://goo.gl/xXJWCS -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FirstNet</title>
    <link rel="stylesheet" href="css/reset.css" type="text/css">
    <link rel="stylesheet" href="css/app.css" type="text/css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
    <script src="https://js.arcgis.com/4.6/"></script>
    <script>

      window.addEventListener("deviceorientation", handleOrientation, true);
      function handleOrientation(event) {
        var absolute = event.absolute;
        var alpha    = event.alpha;
        var beta     = event.beta;
        var gamma    = event.gamma;
        let x = document.getElementById('x');
        x.innerHTML = alpha;
      }

      require([
          "esri/WebMap",
          "esri/views/MapView",
          "esri/geometry/Point",
          "esri/layers/FeatureLayer",
          "esri/tasks/support/Query",
          "dojo/domReady!"
        ], function(WebMap, MapView, Point, FeatureLayer, Query) {

        var webmap = new WebMap({
          portalItem: {
            id: "5de1a19c33364dc08ecfbe4733f34030" // This was created in the "Style a web map" and "Configure pop-ups" design labs
          }
        });

        var view = new MapView({
          container: "viewDiv",
          map: webmap
        });

        const fl = new FeatureLayer({
            portalItem: {  // autocasts as esri/portal/PortalItem
            id: "b71dc98673d44d94b265494a8a43b8ac"
          }
        });

        // fl.queryFeatures().then(e => console.log(e.features));

        function getLocation() {
          // if (navigator.geolocation) {
          //     navigator.geolocation.getCurrentPosition(showPosition);
          // } else {
          //     console.log("Geolocation is not supported by this browser.");
          // }
          showPosition();
        }

        function showPosition(position) {
            var pt = new Point({
              latitude: 34.294878,//position.coords.latitude,
              longitude: -118.553540//position.coords.longitude
            });
            view.center = pt;
            view.rotation = 0;
            performQuery(pt);
        }

        function performQuery(pt) {
          console.log("Performing query");
          var query = fl.createQuery();
          query.geometry = pt; // mapPoint obtained from view-click event.
          query.distance = 0.25;
          query.units = "miles";
          query.spatialRelationship = "intersects"; // All features that intersect 100mi buffer
          let queryResults;
          let featureCallback = (e) => {
            queryResults = e.features;
            console.log(queryResults);
            if (queryResults.length < 20) {
              query.distance = query.distance * 2;
              fl.queryFeatures(query).then(
                featureCallback
              );
            }
          }
          fl.queryFeatures(query).then(
            featureCallback
          );


        }

        getLocation();

        }
    );
    </script>
  </head>
  <body>
    <p id="x"> NO ALPHA RIGHT NOW </p>
    <div id="viewDiv"></div>
  </body>
</html>
