<!-- https://friendly-hamilton-e4a999.netlify.com -->
<!-- https://goo.gl/xXJWCS -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FirstNet</title>
    <link rel="stylesheet" href="css/reset.css" type="text/css">
    <link rel="stylesheet" href="css/app.css" type="text/css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
    <script src="https://js.arcgis.com/4.6/"></script>
    <script>
      Number.prototype.toRad = function() {
         return this * Math.PI / 180;
      }
      window.addEventListener("deviceorientation", handleOrientation, true);
      function handleOrientation(event) {
        var absolute = event.absolute;
        var alpha    = event.alpha;
        var beta     = event.beta;
        var gamma    = event.gamma;
        let x = document.getElementById('x');
        x.innerHTML = alpha;
      }

      require([
          "esri/WebMap",
          "esri/views/MapView",
          "esri/geometry/Point",
          "esri/layers/FeatureLayer",
          "esri/tasks/support/Query",
          "dojo/domReady!"
        ], function(WebMap, MapView, Point, FeatureLayer, Query) {

        var webmap = new WebMap({
          portalItem: {
            id: "5de1a19c33364dc08ecfbe4733f34030" // This was created in the "Style a web map" and "Configure pop-ups" design labs
          }
        });

        var view = new MapView({
          container: "viewDiv",
          map: webmap
        });

        const fl = new FeatureLayer({
            portalItem: {  // autocasts as esri/portal/PortalItem
            id: "b71dc98673d44d94b265494a8a43b8ac"
          }
        });

        // fl.queryFeatures().then(e => console.log(e.features));

        function getLocation() {
          // if (navigator.geolocation) {
          //     navigator.geolocation.getCurrentPosition(showPosition);
          // } else {
          //     console.log("Geolocation is not supported by this browser.");
          // }
          showPosition();
        }

        let lat = 34.294878;
        let lng = -118.553540;

        function showPosition(position) {
            var pt = new Point({
              latitude: lat, //position.coords.latitude,
              longitude: lng //position.coords.longitude
            });
            view.center = pt;
            view.rotation = 0;
            performQuery(pt);
        }

        function performQuery(pt) {
          console.log("Performing query");
          var query = fl.createQuery();
          query.geometry = pt; // mapPoint obtained from view-click event.
          query.distance = 0.25;
          query.units = "miles";
          query.spatialRelationship = "intersects"; // All features that intersect 100mi buffer
          let queryResults;
          let featureCallback = (e) => {
            queryResults = e.features;
            console.log(queryResults);
            if (queryResults.length < 20) {
              query.distance = query.distance * 2;
              fl.queryFeatures(query).then(
                featureCallback
              );
            } else {
              assessNearestWater(queryResults);
            }
          }
          fl.queryFeatures(query).then(
            featureCallback
          );
        }

        function assessNearestWater(sources) {
          sources.forEach(source => {
            let sourcePos = source.geometry.centroid;
            console.log(calculateDistance(lat, lng, sourcePos.latitude, sourcePos.longitude));
          });

        }

        function calculateDistance(myLat, myLng, otherLat, otherLng) {
          console.log("Calculating Distance");
          var R = 3959;
          var x1 = myLat-otherLat;
          var dLat = x1.toRad();
          var x2 = myLng-otherLng;
          var dLon = x2.toRad();
          var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(myLat.toRad()) * Math.cos(otherLat.toRad()) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          var d = R * c;
          return d;
        }

        getLocation();

        }
    );
    </script>
  </head>
  <body>
    <p id="x"> NO ALPHA RIGHT NOW </p>
    <div id="viewDiv"></div>
  </body>
</html>
